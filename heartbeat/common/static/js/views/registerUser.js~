define([
    'jquery',
    'backbone',
    'user',
    'underscore',
    'text!templates/registerUserTemplate.html',
    'jquery.forms',
    'jquery.overlay',
], function($, Backbone, User, _, registerTemplate) {
    var isOpen = false;
    var registerUserClick = false;
    RegisterUser = Backbone.View.extend({
        el: $("#register_form"),
        initialize: function(options) {
            _.bindAll(this, 'render');
            $(this.el).css({
                background: '#EDEDED',
                zIndex: 3000,
                padding: '10px',
                width: '640px',
                height: '240px',
                margin: '0 auto',
                opacity: "1",
                position: 'absolute',
                color: "#FFFFFF",
                top: '10%',
                left: '10%',
                display: "none",
            });
            isOpen = false;
            var close = this.close;
            $("body").die("click").live("click", function () {
                if (isOpen && !registerUserClick) {
                    close();
                    return false;
                } else if (registerUserClick) {
                    registerUserClick = false;
                    return false;
                }
            });
            $(this.el).click(function(event) {
                event.stopPropagation();
            });
            this.render();
            
        },
        render: function() {
            if (!isOpen) {
                this.open();
            }
            isOpen = true;
            registerUserClick = true;
        },
        open: function() {            
            $(this.el).html(_.template(registerTemplate, {
                'username': (this.model.get('username') == null) ? "" : this.model.get('username'),
            }));
            var user = this.model;
            $(this.el).children("form").ajaxForm({
                success: user.logIn,
                
            });
            $("body").css({
                "height": "100%",
                "min-height": "100%",
                "opacity": "0.7",
            });
            $("#content_container").css({
                "height": '100%',
                "min-height": "100%",
            });
            $(this.el).fadeIn("slow");
        },
        close: function() {
            $("body").css({
                "opacity": 1,
            });
            Backbone.history.navigate("/", { trigger: true });
            isOpen = false;
        }
    });
    return RegisterUser;
});