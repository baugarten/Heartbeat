define([
    'jquery',
    'backbone',
    'underscore'
], function ($, Backbone, _) {
    var User = Backbone.Model.extend({
        defaults: {
            username: "",
            loggedin: false,
            isArtist: false,
	    api_key: "",
            artistId: -1,
            csrf_token: ""
        },
        initialize: function() {
            _.bindAll(this, 'logIn');
            var user = this;
            var username = this.get('username');
            var id = this.get('artistId');
            $.ajax({
                type: "GET",
                url: "/api/users/profile/loggedin/",
                beforeSend: function(xhr) {
                    console.log(xhr);
                },
                success: this.logIn,
                complete: function(one, two) {
                    console.log(one);
                    console.log(two);
                }
            });            
        },
        logIn: function(response, status, xhr, form) {
            var username = response['username'];
            var artistId = parseInt(response['artistId']);
	    if (undefined != response['api_key']
		|| void 0 != response['api_key']) {
	        this.set({ "api_key": response['api_key'] });
	    }
            if (undefined != response['csrf_token']
                || void 0 != response['csrf_token']) {
                this.set({ "csrf_token": response['csrf_token'] });
            }
            if (username == null) {
                this.trigger("change");
                this.trigger("error", "Illegal username, password combination");
                return false;
            }
            var isArtist = (artistId > 0)
            this.set({ 
                username: username,
                artistId: artistId,
                isArtist: isArtist,
                loggedin: true,
            });
            this.trigger("login");
            return true;
        },
        logOut: function() {
            var data = "csrfmiddlewaretoken=" + this.get("csrf_token");
	    data += "&username=" + this.get("username");
            $.ajax({
                type: "GET",
                url: "/api/users/profile/logout",
                data: data,
                complete: function(a, b) {
                    console.log(a);
                    console.log(b);
                },
            });
            this.set({
                username: "",
                loggedin: false,
                isArtist: false
            });
            this.trigger("logout");
        }
    });
    return User;
});
